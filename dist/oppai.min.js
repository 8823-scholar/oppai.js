/*! oppai.js / @version:0.1.0 @author:dameleon <dameleon@gmail.com> @license:MIT */ 
!function(a){"use strict";function b(){var a=[].slice.call(arguments),b=a.shift(),c=a.shift(),e=a.shift();this.setting=d({imgPath:c},w,e),this.canvas=p(b),this.ctx=this.canvas.getContext("2d"),this.image=null,this.breasts=[],this._oppList=a}function c(a,b){return t.isTouchDevice?a.changedTouches[0][b]:a[b]}function d(){function a(a,b,e){var f=e[a],g=b[a],h=f&&typeof f||"",i=g&&typeof g||"";c.test(h)?(i!==h&&(b[a]="object"===h?{}:[]),d(b[a],f)):b[a]=f}if(arguments.length<2)return arguments[0];for(var b,c=/(object|array)/,e=[].slice.call(arguments),f=e.shift(),g=0;b=e[g];){var h=0;switch(typeof b){case"array":for(var i=b.length;i>h;h++)a(h,f,b);break;case"object":for(var j,k=Object.keys(b);j=k[h];h++)a(j,f,b)}g++}return f}function e(a){var b=this;this._loadImage(this.setting.imgPath,function(){b._init(),a&&a()})}function f(){var c,d,e,f,g,h=this._oppList,i=this.canvas,j=this.ctx,k=this.image,l=this.breasts;if(d=e=99999,f=g=0,i.width=k.width,i.height=k.height,this.setting.dpr>1){var m=this.setting.dpr;i.style.width=k.width/m+"px",i.style.height=k.height/m+"px"}j.drawImage(k,0,0);for(var n,o=0;n=h[o];o++)l[o]=new b.Breast(j,k,n),c=l[o].getBoundingBox(),d=r.min(d,c.minX),e=r.min(e,c.minY),f=r.max(f,c.maxX),g=r.max(g,c.maxY);var p=20;this.drawAABB={x:r.max(0,d-p),y:r.max(0,e-p),w:r.min(i.width,f+p),h:r.min(i.height,g+p)},this.drawAABB.w-=this.drawAABB.x,this.drawAABB.h-=this.drawAABB.y,this.drawAABB.center={x:this.drawAABB.x+this.drawAABB.w/2,y:this.drawAABB.y+this.drawAABB.h/2},t.isTouchDevice&&"ondevicemotion"in a&&this._initTouchHandler(),this.setting.enableTouch&&i.addEventListener(u.tap,this),this.update()}function g(){this.bounce(80,3e3)}function h(){var a=this;this.motionHandler=new b.MotionHandler(function(b){var c=b.distance;a.swing(r.min(90,b.x/c*100),r.min(90,b.y/c*100))}),this.motionHandler.on()}function i(a,b){var c=this,d=new Image,e=function(){var a=c.image=s.createElement("canvas");a.width=d.naturalWidth,a.height=d.naturalHeight,a.getContext("2d").drawImage(d,0,0),b()};d.onerror=function(){throw new Error("cannot load image [src]: "+a)},d.src=a,t.isIE?0!==d.width?e():d.onload=function(){setTimeout(e,200)}:d.onload=e}function j(){var a=this.breasts,b=this.drawAABB;if(!b)return void console.warn("drawAABB is not set yet");this.ctx.drawImage(this.image,b.x,b.y,b.w,b.h,b.x,b.y,b.w,b.h);for(var c,d=0;c=a[d];d++)c.draw()}function k(a,b){for(var c,d=this.breasts,e=0;c=d[e];e++)c.moveTo(a,b);this.update()}function l(a,b,c){var d=this,e=function(c,e){d.moveAll(a-c,b-e)},f=this._createAnimation(c||3e3,e);f.start({start:0,end:a},{start:0,end:b})}function m(a,b){var c=this,d=function(b){c.moveAll(0,a-b)},e=this._createAnimation(b||3e3,d);e.start({start:0,end:a})}function n(a,b){var c=this,d=function(b){c.moveAll(a-b,0)},e=this._createAnimation(b||3e3,d);e.start({start:0,end:a})}function o(a,c,d){var e=this;this.animation&&this.animation.end();var f=function(){e.animation=null,d&&d()};return this.animation=new b.Animation(a,c,f)}function p(a){var b;if("string"==typeof a){if(b=s.querySelector(a),!b)throw new Error("")}else{if(!a||"canvas"!==a.tagName.toLowerCase())throw new Error("");b=a}return b}function q(b){var c={};if(b=b.toLowerCase(),c.isAndroid=/android/.test(b),c.isIos=/ip(hone|od|ad)/.test(b),c.isTouchDevice="ontouchstart"in a,c.versionString=null,c.version=[],c.isAndroid||c.isIos?(c.isChrome=/(chrome|crios)/.test(b),c.isAndroidBrowser=!c.isChrome&&c.isAndroid&&/applewebkit/.test(b),c.isMobileSafari=!c.isAndroid&&c.isIos&&/applewebkit/.test(b),c.versionString=c.isAndroidBrowser||c.isAndroid&&c.isChrome?b.match(/android\s(\S.*?)\;/):c.isMobileSafari||c.isIos&&c.isChrome?b.match(/os\s(\S.*?)\s/):null,c.versionString=c.versionString?c.isIos?c.versionString[1].replace("_","."):c.versionString[1]:null,c.versionString&&(c.version=c.versionString.split("."))):(c.isIE=/trident/.test(b)||/msie/.test(b),c.isIE&&((c.versionString=b.match(/rv:([\d\.]+)/))||(c.versionString=b.match(/msie\s([0-9]{1,}[\.0-9]{0,})/)))&&(c.versionString=c.versionString[1],c.version=c.versionString.split("."))),c.version)for(var d,e=0;d=c.version[e];e++)c.version[e]=0|d;return c}var r=a.Math,s=a.document,t=q(a.navigator.userAgent),u={touchStart:t.isTouchDevice&&"touchstart"||"mousedown",touchMove:t.isTouchDevice&&"touchmove"||"mousemove",touchEnd:t.isTouchDevice&&"touchend"||"mouseup",tap:t.isTouchDevice&&"touchstart"||"click"},v=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b){return function(c){a.setTimeout(c,b)}}(1e3/60),w={dpr:1,enableTouch:!1};b.getTouchInfoFromEvent=c,b.extend=d,b.env=t,b.requestAnimationFrame=v,b._debug=!1,b.prototype={constructor:b,_createAnimation:o,_init:f,_initTouchHandler:h,_loadImage:i,bounce:m,load:e,handleEvent:g,moveAll:k,roll:n,swing:l,update:j},a.Oppai=b,"process"in a||"function"!=typeof a.define||!a.define.amd||define([],function(){return b})}(this.self||global,void 0),function(a){"use strict";function b(a,b,c){this.isPlaying=!1,this._animate=!0,this.valueList=[],this.handler=b,this.endHandler=c,this.duration=a||1500,this.startTime=null,this.endTime=null,this.currentTime=null}function c(a,b,c,e,f,g){if(0===a)return b;if(1===(a/=e))return b+c;g||(g=.3*e);var h;return!f||f<d.abs(c)?(f=c,h=g/4):h=g/(2*d.PI)*d.asin(c/f),f*d.pow(2,-10*a)*d.sin(2*(a*e-h)*d.PI/g)+c+b}if(!a.Oppai)throw new Error('Undefined object: "Oppai"');var d=a.Math,e=a.Date,f=a.Oppai.requestAnimationFrame;b.prototype={constructor:b,start:function(){this.valueList=this.valueList.concat([].slice.call(arguments)),this.isPlaying=!0,this.startTime=e.now(),this.endTime=this.startTime+this.duration,this._animation()},end:function(){this.isPlaying=!1,this._animate=!1,this.endHandler&&this.endHandler()},reset:function(){for(var a=[],b=0,c=this.valueList.length;c>b;b++)a[a.length]=0;this.handler.apply(null,a),this.end()},_animation:function(){for(var a,b=this,d=this.duration,g=this.currentTime=e.now(),h=g-this.startTime,i=g>=this.endTime,j=this.valueList,k=[],l=.11782*d,m=0;a=j[m];m++)k[k.length]=i?a.end:c(h,a.start,a.end,d,null,l);this.handler.apply(null,k),i?this.end():this._animate&&f(function(){b._animation()})}},a.Oppai.Animation=b}(this.self||global,void 0),function(a,b){"use strict";function c(b,c,d){this.isDebug=a.Oppai._debug,this.vertexPoint=null,this.radiallyLines=[],this.ctx=b,this.drawBufferCtx=null,this.image=null,this.resolution=2,this.initialize(d,c)}function d(a,b){var c,d,e,f,g,h,i=this.resolution,j=this.vertexPoint,k=a/100*(0>a?j.x:a>0?this.width-j.x:0),l=b/100*(0>b?j.y:b>0?this.height-j.y:0),m=this.radiallyLines,p=o.atan2(l,k),q=n(p),r=o.sqrt(k*k+l*l),s=1/this.resolution,t=0;for(q>=0&&90>q?(g=this.width-j.x,h=j.y):q>=90&&180>q?(g=j.x,h=j.y):q>=180&&270>q?(g=j.x,h=this.height-j.y):q>=270&&(g=this.width-j.x,h=this.height-j.y),f=o.sqrt(g*g+h*h),r>f&&(r=f,k=f*o.cos(p)+j.x,l=f*o.sin(p)+j.y),this.drawBufferCtx=this.bufferHandler.getDrawBufferCtx(),this.drawBufferCtx.clearRect(0,0,this.width+1,this.height+1),j.setMoveValue(k,l);c=m[t];t++){for(e=c.length-i;d=c[e];){var u=o.abs(q-d.angle),v=s*(e+1);60>u?v*=d.distance>r?.5:.85:u>300&&(v*=1.2),d.setMoveValue(k*v,l*v),e--}t>0&&this.drawBetweenLines(m[t-1],c)}this.drawBetweenLines(m[t-1],m[0]),this.bufferHandler.drawComplete()}function e(a,b){function c(a,b,c,d,e){var f=[];if(e>1)for(var g=(c-a)/e,h=(d-b)/e,i=1;e>i;i++)f[f.length]=new j(a+g*i,b+h*i,a,b);return f[f.length]=new j(c,d,a,b),f}var d,e,f,g,h,i,k,l,m=a.vertex,n=this.resolution,p=a.round_coords,q=this.radiallyLines;for(d=e=99999,f=g=0,k=0,l=null;l=p[k];k++)d=o.min(d,l[0]),e=o.min(e,l[1]),f=o.max(f,l[0]),g=o.max(g,l[1]);var r=m[0]-d,s=m[1]-e;for(this.vertexPoint=new j(r,s),k=0,l=null;l=p[k];k++)q[q.length]=c(r,s,l[0]-d,l[1]-e,n);this.baseX=d,this.baseY=e,this.width=h=f-d,this.height=i=g-e,this.bufferHandler=new Oppai.RenderBufferHandler(b,d,e,h,i),this.image=this.bufferHandler.getSrcCanvas()}function f(){this.ctx.drawImage(this.bufferHandler.getDrewCanvas(),this.baseX,this.baseY)}function g(a,b){var c,d=0;for(this.drawTriangle(a[d],b[d],this.vertexPoint);a[c=d+1];)this.drawTriangle(a[d],b[d],a[c]),this.drawTriangle(b[d],a[c],b[c]),++d}function h(a,b,c){var d=this.drawBufferCtx,e=this.image,f=a.getCurrentXY(),g=b.getCurrentXY(),h=c.getCurrentXY(),i=f.x,j=f.y,k=g.x,l=g.y,n=h.x,o=h.y,p=k-i,q=l-j,r=n-i,s=o-j,t=b.x-a.x,u=b.y-a.y,v=c.x-a.x,w=c.y-a.y,x=new m(t,u,v,w),y=x.getInvert();if(y){var z,A,B,C;z=y.a*p+y.b*r,B=y.c*p+y.d*r,A=y.a*q+y.b*s,C=y.c*q+y.d*s,d.save(),d.beginPath(),d.moveTo(i,j),d.lineTo(k,l),d.lineTo(n,o),d.closePath(),d.clip(),d.transform(z,A,B,C,i-(z*a.x+B*a.y),j-(A*a.x+C*a.y)),d.drawImage(e,0,0),this.isDebug&&(d.strokeStyle="blue",d.stroke()),d.restore()}}function i(){return{minX:this.baseX,minY:this.baseY,maxX:this.baseX+this.width,maxY:this.baseY+this.height}}function j(a,c,d,e){this.x=a,this.y=c,this.moveX=0,this.moveY=0,d!==b&&e!==b?(this.distX=d-this.x,this.distY=e-this.y,this.distance=o.sqrt(this.distX*this.distX+this.distY*this.distY),this.radian=o.atan2(this.distY,this.distX),this.angle=n(this.radian)):(this.distX=0,this.distY=0,this.distance=0,this.radian=null,this.angle=null)}function k(){return{x:this.x+this.moveX,y:this.y+this.moveY}}function l(a,b){this.moveX=a,this.moveY=-b}function m(a,b,c,d){this.a=a,this.b=b,this.c=c,this.d=d}function n(a){return a*(180/o.PI)}if(!a.Oppai)throw new Error('Undefined object: "Oppai"');var o=a.Math;c.prototype={constructor:c,draw:f,drawBetweenLines:g,drawTriangle:h,initialize:e,moveTo:d,getBoundingBox:i},j.prototype={constructor:j,getCurrentXY:k,setMoveValue:l},m.prototype.getInvert=function(){var a=this.a*this.d-this.b*this.c;return a>-1e-4&&1e-4>a?null:new m(this.d/a,-this.b/a,-this.c/a,this.a/a)},a.Oppai.Breast=c}(this.self||global,void 0),function(a){"use strict";function b(a){this.startThreshold=12,this.endThreshold=7,this.handler=a,this.state=d.NONE,this.currentVector=null}if(!a.Oppai)throw new Error('Undefined object: "Oppai"');var c=a.Math,d={NONE:0,WAIT:1};b.prototype={constructor:b,handleEvent:function(a){var b=a.acceleration,e=c.sqrt(b.x*b.x+b.y*b.y);this.state===d.NONE&&e>=this.startThreshold?(this.currentVector={distance:e,x:b.x,y:b.y},this.state=d.WAIT):this.state===d.WAIT&&e<this.endThreshold&&(this.off(),this.handler(this.currentVector),this.currentVector=null,this.state=d.NONE,this.on())},on:function(){a.addEventListener("devicemotion",this)},off:function(){a.removeEventListener("devicemotion",this)}},a.Oppai.MotionHandler=b}(this.self||global,void 0),function(a){"use strict";function b(b,d,e,f,g){var h=this.srcCanvas=c.createElement("canvas");h.width=f,h.height=g,this.srcCtx=h.getContext("2d"),this.canvases=[],this.contexts=[];for(var i,j=0,k=2;k>j;j++)i=h.cloneNode(),this.canvases.push(i),this.contexts.push(i.getContext("2d"));if(this.currentBufferIndex=0,this.drewBufferIndex=1,this.srcCtx.drawImage(b,d,e,f,g,0,0,f,g),a.Oppai._debug){c.body.appendChild(this.srcCanvas);for(var l,m=0;l=this.canvases[m];m++)c.body.appendChild(l)}}if(!a.Oppai)throw new Error('Undefined object: "Oppai"');var c=a.document;b.prototype={constructor:b,getSrcCanvas:function(){return this.srcCanvas},getDrawBufferCtx:function(){return this.contexts[this.currentBufferIndex]},drawComplete:function(){var a=this.drewBufferIndex;this.drewBufferIndex=this.currentBufferIndex,this.currentBufferIndex=a},getDrewCanvas:function(){return this.canvases[this.drewBufferIndex]}},a.Oppai.RenderBufferHandler=b}(this.self||global,void 0);
//# sourceMappingURL=oppai.min.js.map